<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0" />
	<title>LearnEase</title>

	<!--=== CSS ===-->

	<!-- Bootstrap -->
	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="/extensions/jquery-ui-1.12.0/jquery-ui.min.css" type="text/css">
	<!-- jQuery UI -->
	<!--<link href="plugins/jquery-ui/jquery-ui-1.10.2.custom.css" rel="stylesheet" type="text/css" />-->
	<!--[if lt IE 9]>
		<link rel="stylesheet" type="text/css" href="plugins/jquery-ui/jquery.ui.1.10.2.ie.css"/>
	<![endif]-->

	<!-- Theme -->
	<link href="assets/css/main.css" rel="stylesheet" type="text/css" />
	<link href="assets/css/plugins.css" rel="stylesheet" type="text/css" />
	<link href="assets/css/responsive.css" rel="stylesheet" type="text/css" />
	<link href="assets/css/icons.css" rel="stylesheet" type="text/css" />

	<link rel="stylesheet" href="assets/css/fontawesome/font-awesome.min.css">
	<!--[if IE 7]>
		<link rel="stylesheet" href="assets/css/fontawesome/font-awesome-ie7.min.css">
	<![endif]-->

	<!--[if IE 8]>
		<link href="assets/css/ie8.css" rel="stylesheet" type="text/css" />
	<![endif]-->
	
	<link rel="stylesheet" href="/extensions/zTree_v3/css/demo.css" type="text/css">
	<link rel="stylesheet" href="extensions/zTree_v3/css/zTreeStyle/zTreeStyle.css" type="text/css">

	<!--=== JavaScript ===-->

	<!-- <script type="text/javascript" src="assets/js/libs/jquery-1.10.2.min.js"></script> -->
	<script type="text/javascript" src="/extensions/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="plugins/jquery-ui/jquery-ui-1.10.2.custom.min.js"></script>

	<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="assets/js/libs/lodash.compat.min.js"></script>

	<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
	<!--[if lt IE 9]>
		<script src="assets/js/libs/html5shiv.js"></script>
	<![endif]-->

	<!-- Smartphone Touch Events -->
	<script type="text/javascript" src="plugins/touchpunch/jquery.ui.touch-punch.min.js"></script>
	<script type="text/javascript" src="plugins/event.swipe/jquery.event.move.js"></script>
	<script type="text/javascript" src="plugins/event.swipe/jquery.event.swipe.js"></script>

	<!-- General -->
	<script type="text/javascript" src="assets/js/libs/breakpoints.js"></script>
	<script type="text/javascript" src="plugins/respond/respond.min.js"></script> <!-- Polyfill for min/max-width CSS3 Media Queries (only for IE8) -->
	<script type="text/javascript" src="plugins/cookie/jquery.cookie.min.js"></script>
	<script type="text/javascript" src="plugins/slimscroll/jquery.slimscroll.min.js"></script>
	<script type="text/javascript" src="plugins/slimscroll/jquery.slimscroll.horizontal.min.js"></script>

	<!-- Page specific plugins -->
	<!-- Charts -->
	<!--[if lt IE 9]>
		<script type="text/javascript" src="plugins/flot/excanvas.min.js"></script>
	<![endif]-->
	<script type="text/javascript" src="plugins/sparkline/jquery.sparkline.min.js"></script>
	<script type="text/javascript" src="plugins/flot/jquery.flot.min.js"></script>
	<script type="text/javascript" src="plugins/flot/jquery.flot.tooltip.min.js"></script>
	<script type="text/javascript" src="plugins/flot/jquery.flot.resize.min.js"></script>
	<script type="text/javascript" src="plugins/flot/jquery.flot.time.min.js"></script>
	<script type="text/javascript" src="plugins/flot/jquery.flot.growraf.min.js"></script>

	<script type="text/javascript" src="plugins/daterangepicker/moment.min.js"></script>
	<script type="text/javascript" src="plugins/daterangepicker/daterangepicker.js"></script>
	<script type="text/javascript" src="plugins/blockui/jquery.blockUI.min.js"></script>

	<!-- App -->
	<script type="text/javascript" src="assets/js/app.js"></script>
	<script type="text/javascript" src="assets/js/plugins.js"></script>
	<script type="text/javascript" src="assets/js/plugins.form-components.js"></script>
	
	<!-- ZTree -->
	<script type="text/javascript" src="extensions/zTree_v3/js/jquery.ztree.all.js"></script>

	<script>
	$(document).ready(function(){
		"use strict";

		App.init(); // Init layout and core plugins
		Plugins.init(); // Init all plugins
		FormComponents.init(); // Init all form-specific plugins
	});
	</script>

	<!-- Demo JS -->
	<script type="text/javascript" src="assets/js/custom.js"></script>
	
	<style type="text/css">
		strong {font-weight: 700;}
		a {text-decoration: none;}
		.dropdown-menu li {list-style:none}
	</style>
</head>

<body>
	<header class="header navbar navbar-fixed-top" role="banner" th:include="/common/common_navigation :: manage-common-navidation">
	</header>
	<!-- /.header -->

	<div id="container">
		<!-- Sidebar -->
		<div id="sidebar" class="sidebar-fixed" th:include="/common/manage_common_sidebar :: manage_common_siderbar">
	    </div>
	    <!-- /Sidebar -->
	    
		<div id="content">
			<div class="container" style="margin-left: 70px; margin-top:50px">
				<button type="button" class="btn btn-primary" id="add_root">添加</button>
				<button type="button" class="btn btn-primary" id="update_status">更新</button>
				<button type="button" class="btn btn-primary" id="expandAll">展开</button>
			</div>
			<div class="container" style="margin-left: 50px;">
				<div class="col-md-5">
					<div class="content_wrap">
						<div class="zpermission_manageBackground left">
							<ul id="permission_tree" class="ztree"></ul>
						</div>
					</div>
					
					<!-- Dialog -->
					<div id="add_root_permission" title="添加根权限" style="display:none;">
					    <form>
					    	<div class="row">
							<div class="form-group">
									<label class="col-md-3 control-label">权限名:</label>
									<div class="col-md-8">
										<input type="text" id="root_name" name="regular" class="form-control">
									</div>
							</div><br/><br/>
							<div class="form-group">
								<label class="col-md-3 control-label">类型:</label>
								<div class="col-md-8">
									<select class="form-control" id="root_isCatalog">
										<option value="true">目录</option>
										<option value="false">权限</option>
									</select>
								</div>
							</div>
							</div>
						</form>
					</div>
					<div id="add_permission" title="添加权限" style="display:none;">
					    <form>
					    	<div class="row">
							<div class="form-group">
									<label class="col-md-3 control-label">权限名:</label>
									<div class="col-md-8">
										<input type="text" id="add_name" name="regular" class="form-control">
									</div>
							</div><br/>
							<div class="form-group">
								<label class="col-md-3 control-label">权限代码:</label>
								<div class="col-md-8">
								<input type="text" id="add_code" name="regular" class="form-control">
								</div>
							</div><br/>
							<div class="form-group">
								<label class="col-md-3 control-label">类型:</label>
								<div class="col-md-8">
									<select class="form-control" id="add_isCatalog">
										<option value="true" selected="selected">目录</option>
										<option value="false">权限</option>
									</select>
								</div>
							</div>
							</div>
						</form>
					</div>
					<div id="update_permission" title="修改权限" style="display:none;">
					    <form>
					    	<div class="row">
							<div class="form-group">
									<label class="col-md-3 control-label">权限名:</label>
									<div class="col-md-8">
										<input type="text" id="up_name" name="regular" class="form-control">
									</div>
							</div><br/>
							<div class="form-group">
								<label class="col-md-3 control-label">权限代码:</label>
								<div class="col-md-8">
								<input type="text" id="up_code" name="regular" class="form-control">
								</div>
							</div><br/>
							<div class="form-group">
								<label class="col-md-3 control-label">类型:</label>
								<div class="col-md-8">
									<select class="form-control" id="up_isCatalog">
										<option value="true">目录</option>
										<option value="false">权限</option>
									</select>
								</div>
							</div>
							</div>
						</form>
					</div>
					<!-- / Dialog -->
					
				</div>
			</div>
			<!-- /.container -->
		</div>
	</div>
	<script type="text/javascript">
		var permission_tree = {
			expand: true,
			init: function() {
				$.get("permission_all",{},function(result) {
					var setting = {
						edit: {
						   drag: {
							   autoExpandTrigger: false,
							   isCopy: false,
							   isMove: true
						   },
						   enable: true,
						   showRemoveBtn: true,
						   showRenameBtn: false
					   	},
						check : {enable : true,nocheckInherit : true},
						data: {simpleData: {enable: true}},
						view: {
							showIcon: true,
							addHoverDom: permission_tree.addHoverDom,
							removeHoverDom: permission_tree.removeHoverDom
						},
						callback: {
							beforeRemove: permission_tree.beforeRemove,
							onClick: permission_tree.onClick,
							onDrop: zTreeOnDrop
						}
					};
					$.fn.zTree.init($("#permission_tree"), setting, result).expandAll(true);
				},"json");
			},
			onClick: function(event, treeId, treeNode){},
		    addHoverDom: function(treeId, treeNode) {
		        if (treeNode.editNameFlag || $("#permission_addBtn_" + treeNode.id).length > 0)
		           return;
				var sObj = $("#" + treeNode.tId + "_span");
				var addStr = "<span class='button add' id='permission_addBtn_"+ treeNode.id + "' title='增加' onfocus='this.blur();'>"+
							"<img src='/extensions/zTree_v3/css/zTreeStyle/add_1.png' style='margin-bottom:-4px;'/></span>" +
		       				"<span class='button edit' id='permission_editBtn_"+ treeNode.id + "' title='修改' onfocus='this.blur();'></span>";
				sObj.append(addStr);
				var addbtn = $("#permission_addBtn_" + treeNode.id);
				if (addbtn) {
		           addbtn.bind("click", function() {
		               permission_add_dialog.open(treeNode);
		           });
				}
		       
		       var editbtn = $("#permission_editBtn_" + treeNode.id);
		       if (editbtn) {
		           editbtn.bind("click", function() {
		           		permission_up_dialog.open(treeNode);
		           });
		       }
		    },
		    removeHoverDom: function(treeId, treeNode) {
		        $("#permission_addBtn_" + treeNode.id).unbind().remove();
				$("#permission_editBtn_" + treeNode.id).unbind().remove();
		    },
		    beforeRemove: function(treeId, treeNode) {
		        var zTree = $.fn.zTree.getZTreeObj(treeId);
				zTree.selectNode(treeNode);
				if(treeNode.isParent) {
		           alert("存在子权限！");
		           return false;
				}
				if(confirm("确认删除权限<" + treeNode.name + ">？")) {
		           var params = {"id": treeNode.id};
		           $.post("/permission/del", params, function (data) {
		               if (data.status == 0) {
		                   alert(data.msg);
		                   return true;
		               } else if(data.status == 1) {
		            	   alert(data.msg);
		                   return false;
		               }else{
		            	   alert(data.msg);
		                   return false;
		               }
		           });
				}else{
		           return false;
				}
		    },
		    expAll: function(){
			    if(permission_tree.expand) {
			    	$.fn.zTree.getZTreeObj("permission_tree").expandAll(false);
			        permission_tree.expand = false;
			    } else {
			    	$.fn.zTree.getZTreeObj("permission_tree").expandAll(true);
			        permission_tree.expand = true;
			    }
		    },
		    checkAll: function(){
			    if(permission_tree.check) {
			    	$.fn.zTree.getZTreeObj("permission_tree").checkAllNodes(false);
			        permission_tree.check = false;
			    } else {
			    	$.fn.zTree.getZTreeObj("permission_tree").checkAllNodes(true);
			        permission_tree.check = true;
			    }
		    },
		};
		var permission_add_root_dialog = {
			open: function() {
				$("#root_name").val("");
				$("#root_code").val("");
				var add_root_dialog = $( "#add_root_permission" ).dialog({
				      height: 200,
				      width: 450,
				      resizable: false,
				      buttons: {
				    	  "添加": function() {
							var name = $("#root_name").val();
							var isCatalog = $('#root_isCatalog option:selected').val() == "true" ? true : false;
							var params = {
								"name": name,
								"isCatalog": isCatalog
							};
							$.post("permission/add",params,function(result){
								if(result.success == "true" || result.success == true) {
									add_root_dialog.dialog( "close" );
									$.fn.zTree.getZTreeObj("permission_tree").addNodes(null, -1, result.msg, true);
								}else{
									add_root_dialog.dialog( "close" );
									alert(result.msg);
								}
								
							},"json");
				    	  },
				          "取消": function() {
				        	  add_root_dialog.dialog( "close" );
				          }
				        },
				});
			}
		};
		var permission_add_dialog = {
			open: function(treeNode) {
				$("#add_name").val("");
				$("#add_code").val("");
				var add_dialog = $( "#add_permission" ).dialog({
				      height: 250,
				      width: 450,
				      resizable: false,
				      buttons: {
				    	  "添加": function() {
							var name = $("#add_name").val();
							var code = $("#add_code").val();
							var isCatalog = $('#add_isCatalog option:selected').val() == "true" ? true : false;
							var params = {
								"name": name,
								"code": code,
								"isCatalog": isCatalog,
								"pid": treeNode.id
							};
							$.post("permission/add",params,function(result){
								if(result.success == "true" || result.success == true) {
									add_dialog.dialog( "close" );
									var index = treeNode.getIndex()+1;
									$.fn.zTree.getZTreeObj("permission_tree").addNodes(treeNode, index, result.msg);
								}else{
									add_dialog.dialog( "close" );
									alert(result.msg);
								}
								
							},"json");
				    	  },
				          "取消": function() {
				        	  add_dialog.dialog( "close" );
				          }
				        },
				});
			}
		};
		var permission_up_dialog = {
			open: function(treeNode) {
				$("#up_name").val(treeNode.name);
				$("#up_code").val(treeNode.code);
				$("#up_isCatalog").find("option[value='"+treeNode.isCatalog+"']").attr("selected",true);
				var up_dialog = $( "#update_permission" ).dialog({
				      height: 250,
				      width: 450,
				      resizable: false,
				      buttons: {
				    	  "更新": function() {
							var name = $("#up_name").val();
							var code = $("#up_code").val();
							var isCatalog = $('#up_isCatalog option:selected').val() == "true" ? true : false;
							var params = {
								"id": treeNode.id,
								"name": name,
								"code": code,
								"isCatalog": isCatalog,
								"pid": treeNode.id
							};
							$.post("permission/update",params,function(result){
								if(result.success == "true" || result.success == true) {
									up_dialog.dialog( "close" );
									treeNode.name = name;
									treeNode.code = code;
									$.fn.zTree.getZTreeObj("permission_tree").updateNode(treeNode, true);
								}else{
									up_dialog.dialog( "close" );
									alert(result.msg);
								}
								
							},"json");
				    	  },
				          "取消": function() {
				        	  up_dialog.dialog( "close" );
				          }
				        },
				});
			}
		};
		$(function() {
			permission_tree.init();
			
			//添加根节点
			$("#add_root").click(function() {
				permission_add_root_dialog.open();
			});
			
			//更新启用状态
			$("#update_status").click(function() {
				var data = $.fn.zTree.getZTreeObj("permission_tree").getChangeCheckedNodes();
				var upIds = new Array();
				var downIds = new Array();
				$.each(data, function(index, object) {
					if(object.checked) {
						upIds.push(object.id);
					}else{
						downIds.push(object.id);
					}
				});
				var param = {
					"upIds": upIds.join(","),
					"downIds": downIds.join(",")
				};
				$.post("/permission/status/update", param, function(result) {
					alert(result.msg);
				}, "json");
			});
			
			//展开、折叠
			$("#expandAll").click(function() {
				permission_tree.expAll();
			});
		});
		
		//拖拽回调函数
		//isCopy  true：复制；false：移动
		function zTreeOnDrop(event, treeId, treeNodes, targetNode, moveType, isCopy) {
			if(moveType == true) {
				return ;
			}
			if(targetNode == null) {
				return ;
			}
			if(moveType == null) {
				return ;
			}
		    //alert(treeNodes.length + "," + (targetNode ? (targetNode.tId + ", " + targetNode.id) : "isRoot" ));
			var tree = $.fn.zTree.getZTreeObj("permission_tree");
		    var id = treeNodes[0].id;
		    var targetId = targetNode.id;
		    //alert(id+" "+targetId);
		    var param  = {
		    	"id": id,
		    	"targetId": targetId
		    };
		    $.post("/permission/updatePid", param, function(result) {
		    	if(result.success == false) {
		    		alert(result.msg);
		    	}
		    }, "json");
		};
	</script>
</body>
</html>